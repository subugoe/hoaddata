---
title: "Hybrid Open Access Sample Report"
vignette: >
  %\VignetteIndexEntry{Hybrid Open Access Sample Report}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  comment = "#>"
)
options(scipen = 999, digits = 4)
knitr::knit_hooks$set(
  inline = function(x) {
    if (is.numeric(x)) {
      return(formatC(x, big.mark = ",", format = "f", digits = 1, drop0trailing = TRUE))
    } else{
      return(x)
    }
  }
)
```

```{r setup}
library(hoaddata)
library(ggplot2)
library(dplyr)
library(ggiraph)
library(forcats)
library(cowplot)
library(echarts4r)

my_df <- oam_hybrid_jns %>%
  select(-issn) %>%
 # filter(vertrag == "Springer Hybrid (DEAL)") %>%
  inner_join(cc_jn_ind, by = "issn_l") %>%
  distinct()

all_art <- my_df %>% distinct(issn_l, cr_year, jn_all) %>% .$jn_all %>% sum()
```


Our dataset covers **`r length(unique(my_df$issn_l))` hybrid journals**. In these journals,
**`r sum(my_df$cc_total, na.rm = TRUE)` articles** were published **under a Creative Commons license** since 2017. 
The **total share of hybrid open access** in the publication volume of our investigated journals was
**`r round(sum(my_df$cc_total, na.rm = TRUE) / all_art * 100, 2)`%**.

## Creative Commons (CC) license prevalence {.tabset}

```{r}
cc_df <- my_df %>%
  group_by(cr_year, cc) %>%
  summarise(cc_total = sum(cc_total))
all_df <- my_df %>%
  distinct(cr_year, issn_l, jn_all) %>%
  group_by(cr_year) %>%
  summarise(jn_all = sum(jn_all))
cc_ind <- inner_join(cc_df, all_df) %>%
  filter(!is.na(cc)) %>%
  mutate(prop = cc_total / jn_all)
```

Open access article volume since 2017 measured by Creative Commons (CC) license type. Data source: Crossref.

### Absolute {.active}

```{r}
p <- ggplot(cc_ind, aes(cr_year, cc_total, fill = cc, tooltip = paste0(cc, ": ", format(cc_total, big.mark = ",")))) +
  geom_bar_interactive(position = position_stack(reverse = TRUE),
                       stat = "identity") +
  cowplot::theme_minimal_hgrid() +
  scale_y_continuous(labels = scales::number_format(big.mark = ","),
                     expand = expansion(mult = c(0, 0.05))) +
  scale_fill_manual("",
                    values =  c("#65BADA",
                                "#068E8C",
                                "#00A757",
                                "#E5BA52",
                                "#D86F27",
                                "#C82E6B")) +
  labs(y = "Hybrid OA", x = "Year")

girafe(ggobj = p,
       width_svg = 6,
       height_svg = 5 * 0.618)
```
<small>Number of open access articles in hybrid journals per Creative Commons license variant and year</small>


### Relative

```{r}
q <- ggplot(cc_ind, aes(cr_year, prop, fill = cc, tooltip = paste0(cc, ": ", round(prop * 100, 2)))) +
   geom_bar_interactive(stat= "identity",
                        position = position_stack(reverse = TRUE)) +
  cowplot::theme_minimal_hgrid(font_family = "Roboto") +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1L),
                      expand = expansion(mult = c(0, 0.05))) +
    scale_fill_manual("",
                    values =  c("#65BADA",
                                "#068E8C",
                                "#00A757",
                                "#E5BA52",
                                "#D86F27",
                                "#C82E6B")) +
  labs(y = "Hybrid OA Uptake", x = "Year")


girafe(
  ggobj = q,
  width_svg = 6,
  height_svg = 5 * 0.618
)
```

<small>Hybrid open access percentage per Creative Commons license variant and year</small>

### Variance


```{r}
jn_prop <- my_df %>%
  group_by(issn_l, cr_year, jn_all) %>%
  summarise(cc_all = sum(cc_total)) %>%
  mutate(prop = cc_all / jn_all) %>%
  filter(!is.na(prop)) 
qq <- jn_prop %>% 
  ggplot(aes(y = cr_year, x = prop, tooltip = NULL)) +
  ggiraph::geom_boxplot_interactive() +
  geom_vline_interactive(aes(xintercept = median(prop, na.rm = T)),
             colour = "darkorange", linetype ="dashed", size = 1, tooltip = paste0("5-years OA Uptake Median Average:", round(median(jn_prop$prop, na.rm = T) * 100,2), "%")) +
   geom_vline_interactive(aes(xintercept = mean(prop, na.rm = T)),
             colour = "darkorchid", linetype ="dashed", size = 1, tooltip = paste0("5-years OA Uptake Mean Average:", round(mean(jn_prop$prop, na.rm = T) * 100, 2), "%")) +
  coord_cartesian(xlim = c(0, 0.75)) +
  cowplot::theme_minimal_vgrid(font_family = "Roboto") +
  scale_x_continuous(labels = scales::percent_format(accuracy = 1L),
                      expand = expansion(mult = c(0, 0.05))) +
    labs(x = "Hybrid OA Uptake Rate", y = NULL)

girafe(
  ggobj = qq,
  width_svg = 6,
  height_svg = 5 * 0.618
)
```
<small>Distribution of yearly open access uptake rates across journals 
shown as box plot.</small>


## Lead author affiliations

Affiliation analysis of lead authors publishing open access in hybrid journals. 
A [lead author](https://en.wikipedia.org/wiki/Lead_author) is the first named author of a scholarly article who has usually undertaken most of the research presented in the article, although author roles can vary across discipline. We used [OpenAlex](https://openalex.org/) as data source for determining the lead author's affiliation. Overall, OpenAlex recorded lead author affiliations for `r cr_olax_inst %>% filter(!is.na(id)) %>% distinct(doi) %>% nrow()` open access articles in hybrid journals, representing a share of `r cr_olax_inst %>% filter(!is.na(id)) %>% distinct(doi) %>% nrow() / length(unique(cr_olax_inst$doi)) * 100`%.

### By country

```{r}
country_oa_df <- cr_olax_inst %>%
  filter(!is.na(country_code)) %>%
  mutate(country_code_fct = forcats::fct_lump_n(country_code, 10)) %>%
  group_by(country_code_fct) %>%
  summarise(n = n_distinct(doi, na.rm = TRUE)) %>%
  arrange(desc(n)) %>%
  mutate(country_code_fct = fct_inorder(country_code_fct)) %>%
  mutate(country_code_fct = fct_relevel(country_code_fct, "Other", after = Inf))

country_oa_df_plot <- ggplot(country_oa_df, aes(fct_rev(country_code_fct), n, 
                          fill = ifelse(country_code_fct == "DE", "highlight", "normal"))) + 
  geom_bar_interactive(stat = "identity", alpha = 0.8,
                       aes(
                       tooltip = paste(country_code_fct, ":", format(n, big.mark = " ")))) +
  coord_flip() +
   scale_y_continuous(labels = scales::number_format(big.mark = ","),
                      expand = expansion(mult = c(0, 0.05))) +
  geom_text(aes(label = format(n, big.mark = ",")),
             color="white", hjust=1.1) +
  scale_fill_manual(values = c("highlight" = "#0097CE", "normal" = "grey50")) +
  cowplot::theme_minimal_vgrid(font_family = "Roboto") +
  theme(legend.position = "none") +
  labs(x = "Lead author affiliation", y ="Hybrid OA articles")

girafe(
  ggobj = country_oa_df_plot,
  width_svg = 6,
  height_svg = 5 * 0.618
)
```
<small>Affiliations of lead authors publishing open access in hybrid journals by country since 2017.</small>

### By country and institution

```{r}
oalex_country <- cr_olax_inst %>%
  group_by(name = country_code) %>%
  summarise(value = n_distinct(doi))
oalex_inst <- cr_olax_inst %>%
   group_by(country_code, name = display_name) %>%
   summarise(value = n_distinct(doi)) %>%
  tidyr::nest(data = c(name, value))
inner_join(oalex_country,oalex_inst, by = c("name" = "country_code")) %>%
  filter(!is.na(name)) %>%
  rename(children = data) %>%
  e_charts() %>%
  e_treemap(leafDepth = "1", name = "Lead author affiliation") %>%
  e_tooltip() %>%
  e_color(c("#88CCEE",
            "#CC6677",
            "#DDCC77",
            "#117733",
            "#332288",
            "#AA4499",
            "#44AA99",
            "#999933",
            "#882255",
            "#661100",
            "#6699CC",
            "#888888")
  ) %>%
  e_text_style(
    fontFamily = "Roboto"
  )
```

<small>Affiliations of lead authors publishing open access in hybrid journals by country and institution since 2017. Each top-level domain can be subdivided further into domain names representing academic institutions or companies.</small>

### by country and publisher

```{r}
inst_publisher_df <- cr_olax_inst %>%
  filter(!is.na(country_code)) %>%
  mutate(country_code_fct = forcats::fct_lump_n(country_code, 10)) %>%
  mutate(country_code_fct = factor(country_code_fct, levels(country_oa_df$country_code_fct))) %>%
  inner_join(oam_hybrid_jns, by = "issn_l") %>%
  group_by(country_code_fct, vertrag) %>%
  summarise(n = n_distinct(doi))
inst_publisher_plot <- ggplot(inst_publisher_df, aes(fct_rev(country_code_fct), n,
                               fill = ifelse(country_code_fct == "DE", "highlight", "normal"))) +
  geom_bar_interactive(stat = "identity", aes(tooltip = paste(country_code_fct, ":", format(n, big.mark = " ")))) +
  coord_flip() +
  facet_wrap(~ vertrag, ncol = 3, scales = "free_x") +
    scale_fill_manual(values = c("highlight" = "#0097CE", "normal" = "grey50")) +
  cowplot::theme_minimal_vgrid(font_size = 8) +
  theme(legend.position = "none") 
  
girafe(
  ggobj = inst_publisher_plot,
  width_svg = 6,
  height_svg = 15 * 0.618
)
```


